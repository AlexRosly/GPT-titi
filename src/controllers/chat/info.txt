üéØ –¶–µ–ª—å —à–∞–≥–∞ 8

–û—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Å—Ç—Ä–∏–º–æ–º (–∫–∞–∫ –≤ ChatGPT)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å—Ä–∞–∑—É

–¢–æ–∫–µ–Ω—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ —Ñ–∞–∫—Ç—É

–ü—Ä–∏ –Ω—É–ª–µ / –º–∏–Ω—É—Å–µ ‚Äî —Å—Ç—Ä–∏–º —Å—Ä–∞–∑—É –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è

Backend –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ä–∞—Å—Ö–æ–¥

0Ô∏è‚É£ –í–∞–∂–Ω–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞ (—Ä–µ–∞–ª–∏–∑–º)

OpenAI:

‚ùå –Ω–µ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç usage –ø–æ –∫—É—Å–∫–∞–º

‚úÖ usage –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –∫–æ–Ω—Ü–µ

–ü–æ—ç—Ç–æ–º—É –º—ã –¥–µ–ª–∞–µ–º –≥–∏–±—Ä–∏–¥:

—Å—Ç—Ä–∏–º–∏–º —Ç–µ–∫—Å—Ç

—Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ (–ø–æ —Å–∏–º–≤–æ–ª–∞–º / tokenizer)

—Ñ–∏–Ω–∞–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ usage

–¢–∞–∫ –¥–µ–ª–∞—é—Ç –≤—Å–µ (ChatGPT, Poe, Perplexity).

üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
Frontend (EventSource / fetch stream)
        ‚Üì
Backend (SSE)
        ‚Üì
OpenAI (stream=true)

üß≠ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–∞—Ç–∞ (–∏—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞)

–≠—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –Ω–µ –±—ã–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—ã.

FRONTEND
‚îÇ
‚îú‚îÄ‚îÄ 1Ô∏è‚É£ /chat/preview        (estimateCost, –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞)
‚îÇ
‚îú‚îÄ‚îÄ 2Ô∏è‚É£ /chat/send           (pre-charge / reserve)
‚îÇ
‚îî‚îÄ‚îÄ 3Ô∏è‚É£ /stream              (—è–¥—Ä–æ, OpenAI streaming, finalize)

‚ùì –û—Ç–≤–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å
–í –∫–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Ñ—Ä–æ–Ω—Ç –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ /stream?
üîπ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π UX flow

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ

Front ‚Üí /chat/preview

–ø–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—É

–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç (-200)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª Send

Front ‚Üí /chat/send

—Å–µ—Ä–≤–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç: OK, –º–æ–∂–Ω–æ

Front –°–†–ê–ó–£ –ü–û–°–õ–ï —ç—Ç–æ–≥–æ:

–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç SSE / fetch stream

‚Üí /stream

‚ùó /chat/send –Ω–µ —Å—Ç—Ä–∏–º–∏—Ç
‚ùó /stream –Ω–µ —Å—á–∏—Ç–∞–µ—Ç ‚Äú–º–æ–∂–Ω–æ –ª–∏‚Äù

üéØ –†–æ–ª—å –∫–∞–∂–¥–æ–≥–æ —Ä–æ—É—Ç–∞
–†–æ—É—Ç	–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
/chat/preview	–æ—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
/chat/send	–±–∏–∑–Ω–µ—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è + —Ä–µ–∑–µ—Ä–≤
/stream	OpenAI + —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

üß© –®–ê–ì 10 ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä chatSend (–±–µ–∑ –¥—ã—Ä)
–ß—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–æ–¥–µ–ª—å

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å (—Å —É—á—ë—Ç–æ–º -200)

–Ω–∏—á–µ–≥–æ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç

–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ok

5Ô∏è‚É£ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ: –≤—Å—ë —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—á–Ω–æ –∏ —á–∏—Å—Ç–æ
–ö—Ç–æ –∑–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç
–£—Ä–æ–≤–µ–Ω—å	–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
chatSend	–º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∞—Ç—å
streamChat	OpenAI stream
chargeUserPreview	—Å—Ç–æ–ø –ø–æ —Ö–æ–¥—É
finalizeCharge	—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
estimateCost	–ø—Ä–æ–≥–Ω–æ–∑
calculateModelCost	—Ñ–∞–∫—Ç

üëâ –ù–∏ –æ–¥–∏–Ω —Å–ª–æ–π –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É

üîê –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏
–ü—Ä–æ–±–ª–µ–º–∞	–†–µ—à–µ–Ω–∏–µ
–ë–î –¥–µ—Ä–≥–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π chunk	‚ùå ‚Üí ‚úÖ —Ä–∞–∑ –≤ 300 —Ç–æ–∫–µ–Ω–æ–≤
–í–æ–∑–º–æ–∂–µ–Ω —É—Ö–æ–¥ –≤ –º–∏–Ω—É—Å	‚ùå ‚Üí ‚úÖ —Ä–µ–∑–µ—Ä–≤
–î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ	‚ùå ‚Üí ‚úÖ preview ‚â† finalize
–ù–∞–≥—Ä—É–∑–∫–∞	‚ùå ‚Üí ‚úÖ –≤ —Ä–∞–∑—ã –º–µ–Ω—å—à–µ
‚ö†Ô∏è –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ:

‚úî –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ Node-–∏–Ω—Å—Ç–∞–Ω—Å–∞

‚ùå –ù–ï –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

üëâ –î–ª—è scale:

Redis

–∏–ª–∏ Mongo $inc —Å –ª–∏–º–∏—Ç–æ–º

–∏–ª–∏ distributed lock

(—ç—Ç–æ –±—É–¥–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç B)

5Ô∏è‚É£ –ö–∞–∫ —Ñ—Ä–æ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–§—Ä–æ–Ω—Ç:

–¥–µ—Ä–≥–∞–µ—Ç /chat/history

–∫–ª–∞–¥—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ state

–ø–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ /chat/stream